name: Build Release

on:
  push:
    tags:
      - 'v*.*.*'  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ñ‚ÐµÐ³Ð° Ð²ÐµÑ€ÑÐ¸Ð¸ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, v2.6.0)
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

jobs:
  build-release:
    name: Build Production Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð³Ð¾ ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --omit=dev --legacy-peer-deps
          npm install cross-env webpack webpack-cli --legacy-peer-deps

      - name: Build client assets
        run: npm run build
        env:
          NODE_OPTIONS: --openssl-legacy-provider

      - name: Prepare release directory
        run: |
          mkdir -p release-build

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          cp -r assets release-build/
          cp -r server release-build/
          cp -r node_modules release-build/
          cp package.json release-build/
          cp package-lock.json release-build/ || true
          cp config.sample.yml release-build/
          cp LICENSE release-build/
          cp README.md release-build/
          cp CHANGELOG.md release-build/
          cp test-git-nested-folders.md release-build/ || true

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿ÑƒÑÑ‚Ñ‹Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ data (Ð±ÐµÐ· ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ð³Ð¾)
          mkdir -p release-build/data/cache
          mkdir -p release-build/data/uploads
          mkdir -p release-build/data/repo

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ .gitkeep Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹
          touch release-build/data/.gitkeep
          touch release-build/data/cache/.gitkeep
          touch release-build/data/uploads/.gitkeep
          touch release-build/data/repo/.gitkeep

      - name: Create README for data directory
        run: |
          cat > release-build/data/README.md << 'EOF'
          # Data Directory

          This directory is used for Wiki.js application data:

          - `cache/` - Temporary cache files
          - `uploads/` - User uploaded files
          - `repo/` - Git repository for page storage (if Git storage is enabled)

          The database file (`wiki.sqlite` for SQLite or connection to external DB)
          will be created here based on your `config.yml` settings.

          **Note:** This directory is excluded from the release archive.
          It will be populated automatically when you run Wiki.js.
          EOF

      - name: Clean unnecessary files
        run: |
          cd release-build
          
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ dev Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¸Ð· node_modules (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
          # npm prune --production
          
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð½ÐµÐ½ÑƒÐ¶Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          find . -name "*.md5" -type f -delete || true
          find . -name "*.map" -type f -delete || true
          find . -name ".DS_Store" -type f -delete || true
          find . -name "Thumbs.db" -type f -delete || true
          
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ -prune Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ Ð¾ÑˆÐ¸Ð±Ð¾Ðº)
          find . -type d -name "__tests__" -prune -exec rm -rf {} \; 2>/dev/null || true
          find . -type d -name "test" -prune -exec rm -rf {} \; 2>/dev/null || true
          find . -type d -name "tests" -prune -exec rm -rf {} \; 2>/dev/null || true
          find . -name "*.test.js" -type f -delete 2>/dev/null || true
          find . -name "*.spec.js" -type f -delete 2>/dev/null || true

      - name: Get version from tag
        id: version
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="v2.6.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create tar.gz archive
        run: |
          cd release-build
          tar -czf ../wiki-js-${{ steps.version.outputs.version }}.tar.gz \
            --exclude='.git' \
            --exclude='data/wiki.sqlite*' \
            --exclude='data/cache/*' \
            --exclude='data/uploads/*' \
            --exclude='data/repo/*' \
            .

      - name: Create zip archive
        run: |
          cd release-build
          zip -r -q ../wiki-js-${{ steps.version.outputs.version }}.zip \
            -x '.git/*' \
            -x 'data/wiki.sqlite*' \
            -x 'data/cache/*' \
            -x 'data/uploads/*' \
            -x 'data/repo/*' \
            .

      - name: Calculate checksums
        run: |
          sha256sum wiki-js-${{ steps.version.outputs.version }}.tar.gz > wiki-js-${{ steps.version.outputs.version }}.tar.gz.sha256
          sha256sum wiki-js-${{ steps.version.outputs.version }}.zip > wiki-js-${{ steps.version.outputs.version }}.zip.sha256

          echo "## Checksums" > checksums.txt
          echo "" >> checksums.txt
          echo "### tar.gz" >> checksums.txt
          echo '```' >> checksums.txt
          cat wiki-js-${{ steps.version.outputs.version }}.tar.gz.sha256 >> checksums.txt
          echo '```' >> checksums.txt
          echo "" >> checksums.txt
          echo "### zip" >> checksums.txt
          echo '```' >> checksums.txt
          cat wiki-js-${{ steps.version.outputs.version }}.zip.sha256 >> checksums.txt
          echo '```' >> checksums.txt

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release-notes.md << 'EOF'
          # Wiki.js v${{ steps.version.outputs.version }} - Custom Fork

          Enhanced Wiki.js with Git Storage improvements, Approval Workflow, and Russian localization.

          ## ðŸš€ Quick Start

          ### Installation

          ```bash
          # Extract archive
          tar -xzf wiki-js-${{ steps.version.outputs.version }}.tar.gz
          # or
          unzip wiki-js-${{ steps.version.outputs.version }}.zip

          cd release-build

          # Configure
          cp config.sample.yml config.yml
          nano config.yml  # Edit database settings

          # Start
          node server
          ```

          **No `npm install` needed** - all dependencies included!

          ## âœ¨ Features

          ### ðŸ”§ Git Storage - FIXED
          - âœ… Unlimited nested folder depth support
          - âœ… Deleted pages restoration from Git
          - âœ… Automatic directory creation
          - âœ… Improved error handling

          ### ðŸ“‹ Approval Workflow
          - âœ… Complete moderation system
          - âœ… Reviewer comments
          - âœ… Status tracking (DRAFT/PENDING/APPROVED/REJECTED)
          - âœ… Permission-based access control

          ### ðŸŒ Russian Localization
          - âœ… Full UI translation
          - âœ… Moderation interface
          - âœ… English fallback

          ### ðŸŽ¨ UI/UX Improvements
          - âœ… Fixed editor header buttons
          - âœ… Fixed admin panel infinite loading
          - âœ… Improved history page
          - âœ… XSS protection

          ## ðŸ› Bug Fixes

          - Fixed Git storage nested folder creation
          - Fixed deleted pages not reappearing after git pull
          - Fixed admin panel loading issues
          - Fixed duplicate comments in editor and history
          - Fixed permission issues for writers

          ## ðŸ“Š Package Information

          - **Size:** ~250 MB (tar.gz), ~380 MB (zip)
          - **Node.js:** 14.x or later (18.x recommended)
          - **Database:** PostgreSQL, MySQL, MariaDB, SQLite, MSSQL
          - **License:** AGPL-3.0

          ## ðŸ“š Documentation

          - [README.md](README.md) - Overview and setup
          - [CHANGELOG.md](CHANGELOG.md) - Full changelog
          - [test-git-nested-folders.md](test-git-nested-folders.md) - Testing guide

          ## ðŸ™ Credits

          Based on [Wiki.js](https://github.com/Requarks/wiki) by Nicolas Giard
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: github.ref_type == 'tag'
        with:
          name: Wiki.js ${{ steps.version.outputs.version }} - Custom Fork
          body_path: release-notes.md
          files: |
            wiki-js-${{ steps.version.outputs.version }}.tar.gz
            wiki-js-${{ steps.version.outputs.version }}.tar.gz.sha256
            wiki-js-${{ steps.version.outputs.version }}.zip
            wiki-js-${{ steps.version.outputs.version }}.zip.sha256
            checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts (for manual runs)
        if: github.ref_type != 'tag'
        uses: actions/upload-artifact@v4
        with:
          name: wiki-js-release-${{ steps.version.outputs.version }}
          path: |
            wiki-js-${{ steps.version.outputs.version }}.tar.gz
            wiki-js-${{ steps.version.outputs.version }}.tar.gz.sha256
            wiki-js-${{ steps.version.outputs.version }}.zip
            wiki-js-${{ steps.version.outputs.version }}.zip.sha256
            checksums.txt
          retention-days: 30

      - name: Summary
        run: |
          echo "## Build Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Archives Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`wiki-js-${{ steps.version.outputs.version }}.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`wiki-js-${{ steps.version.outputs.version }}.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### File Sizes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh wiki-js-${{ steps.version.outputs.version }}.* >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat checksums.txt >> $GITHUB_STEP_SUMMARY

