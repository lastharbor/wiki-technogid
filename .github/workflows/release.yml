name: Build Release

on:
  push:
    tags:
      - 'v*.*.*'  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ñ‚ÐµÐ³Ð° Ð²ÐµÑ€ÑÐ¸Ð¸ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, v2.6.0)
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

permissions:
  contents: write  # Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ€ÐµÐ»Ð¸Ð·Ð° Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð°ÑÑÐµÑ‚Ð¾Ð²

jobs:
  build-release:
    name: Build Production Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð³Ð¾ ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ

      - name: Prepare release directory
        run: |
          mkdir -p release-build

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ÑÑ…Ð¾Ð´Ð½Ð¸ÐºÐ¸ (Ð‘Ð•Ð— Ð¿Ñ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ ÑÐ±Ð¾Ñ€ÐºÐ¸)
          cp -r client release-build/
          cp -r dev release-build/
          cp -r server release-build/
          cp -r locales release-build/ || true

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          cp package.json release-build/
          cp package-lock.json release-build/
          cp config.sample.yml release-build/
          cp wiki.js release-build/ || true

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ dotfiles (ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð²Ð°Ð¶Ð½Ñ‹Ðµ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸)
          cp .babelrc release-build/
          cp .npmrc release-build/
          cp .editorconfig release-build/ || true
          cp .eslintignore release-build/ || true
          cp .eslintrc.yml release-build/ || true

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°
          cp build.sh release-build/
          cp start.sh release-build/
          chmod +x release-build/build.sh
          chmod +x release-build/start.sh

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ
          cp LICENSE release-build/
          cp README.md release-build/
          cp CHANGELOG.md release-build/
          cp test-git-nested-folders.md release-build/ || true

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿ÑƒÑÑ‚Ñ‹Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ data
          mkdir -p release-build/data/cache
          mkdir -p release-build/data/uploads
          mkdir -p release-build/data/repo

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ .gitkeep Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹
          touch release-build/data/.gitkeep
          touch release-build/data/cache/.gitkeep
          touch release-build/data/uploads/.gitkeep
          touch release-build/data/repo/.gitkeep

      - name: Create README for data directory
        run: |
          cat > release-build/data/README.md << 'EOF'
          # Data Directory

          This directory is used for Wiki.js application data:

          - `cache/` - Temporary cache files
          - `uploads/` - User uploaded files
          - `repo/` - Git repository for page storage (if Git storage is enabled)

          The database file (`wiki.sqlite` for SQLite or connection to external DB)
          will be created here based on your `config.yml` settings.

          **Note:** This directory is excluded from the release archive.
          It will be populated automatically when you run Wiki.js.
          EOF

      - name: Create INSTALL.md
        run: |
          cat > release-build/INSTALL.md << 'EOF'
          # Wiki.js v2.6.0 - Installation Guide

          ## Quick Start

          ```bash
          # 1. Extract archive
          tar -xzf wiki-js-v2.6.0.tar.gz
          # or
          unzip wiki-js-v2.6.0.zip

          cd release-build

          # 2. Build client assets (one time)
          ./build.sh

          # 3. Configure
          cp config.sample.yml config.yml
          nano config.yml  # Edit database settings

          # 4. Start server
          ./start.sh
          ```

          ## Requirements

          - **Node.js**: 14.x or later (16.x or 18.x recommended)
          - **Python 3**: Required for native modules (sqlite3)
          - **Build Tools**: gcc, g++, make (for native module compilation)
          - **Database**: PostgreSQL, MySQL, MariaDB, SQLite, or MSSQL
          - **Memory**: 512 MB minimum, 2 GB recommended
          - **Disk**: 500 MB for application + data storage

          ### System Dependencies

          **ALT Linux:**
          ```bash
          sudo apt-get update
          sudo apt-get install -y python3 python3-module-setuptools python3-module-distutils gcc gcc-c++ make
          ```

          **Debian/Ubuntu:**
          ```bash
          sudo apt-get update
          sudo apt-get install -y python3 python3-setuptools python3-dev build-essential
          ```

          **RHEL/CentOS/Fedora:**
          ```bash
          sudo dnf install -y python3 python3-setuptools python3-devel gcc gcc-c++ make
          ```

          **Note:** The `build.sh` script will detect your Linux distribution and attempt to install these dependencies automatically.

          ## First Build

          The first time you run `./build.sh`, it will:
          - Install all dependencies (~1.8 GB)
          - Compile client assets (~5-10 minutes)
          - Create `assets/` and `node_modules/` directories

          ## Scripts

          - `./build.sh` - Build client assets (run once after extraction)
          - `./start.sh` - Start Wiki.js server

          ## Configuration

          Edit `config.yml` to configure:
          - Database connection
          - Server port (default: 3000)
          - Session secret
          - Other options

          See Wiki.js documentation for details:
          https://docs.js.wiki

          ## Troubleshooting

          **Error: "config.yml not found"**
          - Run: `cp config.sample.yml config.yml`
          - Edit config.yml with your settings

          **Error: "Client assets not found"**
          - Run: `./build.sh` first

          **Database connection errors**
          - Check config.yml database settings
          - Ensure database server is running
          - For SQLite: no external database needed

          ## Support

          - GitHub: https://github.com/YOUR_USERNAME/wiki-fork
          - Documentation: See README.md
          EOF

      - name: Get version from tag
        id: version
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="v2.6.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create tar.gz archive
        run: |
          cd release-build
          tar -czf ../wiki-js-${{ steps.version.outputs.version }}.tar.gz \
            --exclude='.git' \
            --exclude='./data/wiki.sqlite*' \
            .

      - name: Create zip archive
        run: |
          cd release-build
          zip -r -q ../wiki-js-${{ steps.version.outputs.version }}.zip . \
            -x '*.git/*' \
            -x '*data/wiki.sqlite*'

      - name: Calculate checksums
        run: |
          sha256sum wiki-js-${{ steps.version.outputs.version }}.tar.gz > wiki-js-${{ steps.version.outputs.version }}.tar.gz.sha256
          sha256sum wiki-js-${{ steps.version.outputs.version }}.zip > wiki-js-${{ steps.version.outputs.version }}.zip.sha256

          echo "## Checksums" > checksums.txt
          echo "" >> checksums.txt
          echo "### tar.gz" >> checksums.txt
          echo '```' >> checksums.txt
          cat wiki-js-${{ steps.version.outputs.version }}.tar.gz.sha256 >> checksums.txt
          echo '```' >> checksums.txt
          echo "" >> checksums.txt
          echo "### zip" >> checksums.txt
          echo '```' >> checksums.txt
          cat wiki-js-${{ steps.version.outputs.version }}.zip.sha256 >> checksums.txt
          echo '```' >> checksums.txt

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release-notes.md << 'EOF'
          # Wiki.js v${{ steps.version.outputs.version }} - Custom Fork

          Enhanced Wiki.js with Git Storage improvements, Approval Workflow, and Russian localization.

          ## ðŸš€ Quick Start

          ### Installation

          ```bash
          # 1. Extract archive
          tar -xzf wiki-js-${{ steps.version.outputs.version }}.tar.gz
          # or
          unzip wiki-js-${{ steps.version.outputs.version }}.zip

          cd release-build

          # 2. Build client assets (one time)
          ./build.sh

          # 3. Configure
          cp config.sample.yml config.yml
          nano config.yml  # Edit database settings

          # 4. Start server
          ./start.sh
          ```

          **First run requires build** - Run `./build.sh` once to compile assets (~5-10 minutes)

          ## âœ¨ Features

          ### ðŸ”§ Git Storage - FIXED
          - âœ… Unlimited nested folder depth support
          - âœ… Deleted pages restoration from Git
          - âœ… Automatic directory creation
          - âœ… Improved error handling

          ### ðŸ“‹ Approval Workflow
          - âœ… Complete moderation system
          - âœ… Reviewer comments
          - âœ… Status tracking (DRAFT/PENDING/APPROVED/REJECTED)
          - âœ… Permission-based access control

          ### ðŸŒ Russian Localization
          - âœ… Full UI translation
          - âœ… Moderation interface
          - âœ… English fallback

          ### ðŸŽ¨ UI/UX Improvements
          - âœ… Fixed editor header buttons
          - âœ… Fixed admin panel infinite loading
          - âœ… Improved history page
          - âœ… XSS protection

          ## ðŸ› Bug Fixes

          - Fixed Git storage nested folder creation
          - Fixed deleted pages not reappearing after git pull
          - Fixed admin panel loading issues
          - Fixed duplicate comments in editor and history
          - Fixed permission issues for writers

          ## ðŸ“Š Package Information

          - **Size:** ~15 MB (tar.gz), ~20 MB (zip) - source code only
          - **After build:** ~250 MB with node_modules and assets
          - **Node.js:** 14.x or later (18.x recommended)
          - **Database:** PostgreSQL, MySQL, MariaDB, SQLite, MSSQL
          - **License:** AGPL-3.0
          - **Build time:** ~5-10 minutes on first run

          ## ðŸ“š Documentation

          - [INSTALL.md](INSTALL.md) - Installation guide
          - [README.md](README.md) - Overview and setup
          - [CHANGELOG.md](CHANGELOG.md) - Full changelog
          - [test-git-nested-folders.md](test-git-nested-folders.md) - Testing guide

          ## ðŸ™ Credits

          Based on [Wiki.js](https://github.com/Requarks/wiki) by Nicolas Giard
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: github.ref_type == 'tag'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: Wiki.js ${{ steps.version.outputs.version }} - Custom Fork
          body_path: release-notes.md
          files: |
            wiki-js-${{ steps.version.outputs.version }}.tar.gz
            wiki-js-${{ steps.version.outputs.version }}.tar.gz.sha256
            wiki-js-${{ steps.version.outputs.version }}.zip
            wiki-js-${{ steps.version.outputs.version }}.zip.sha256
            checksums.txt
          draft: false
          prerelease: false

      - name: Upload artifacts (for manual runs)
        if: github.ref_type != 'tag'
        uses: actions/upload-artifact@v4
        with:
          name: wiki-js-release-${{ steps.version.outputs.version }}
          path: |
            wiki-js-${{ steps.version.outputs.version }}.tar.gz
            wiki-js-${{ steps.version.outputs.version }}.tar.gz.sha256
            wiki-js-${{ steps.version.outputs.version }}.zip
            wiki-js-${{ steps.version.outputs.version }}.zip.sha256
            checksums.txt
          retention-days: 30

      - name: Summary
        run: |
          echo "## Build Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Archives Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`wiki-js-${{ steps.version.outputs.version }}.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`wiki-js-${{ steps.version.outputs.version }}.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### File Sizes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh wiki-js-${{ steps.version.outputs.version }}.* >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat checksums.txt >> $GITHUB_STEP_SUMMARY

